---
import Heart from './icons/Heart.astro';

export interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<div class="like-container flex items-center gap-2">
  <button data-like-button data-slug={slug} aria-label="Like this post">
    <Heart class="like-heart" />
  </button>
  <span class="like-count" data-like-count>&mdash;</span>
</div>

<style>
  button[data-like-button] {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.1s ease;
  }

  button[data-like-button]:focus-visible {
    outline: 2px solid currentColor;
    outline-offset: 2px;
    border-radius: 4px;
  }

  .like-count {
    font-variant-numeric: tabular-nums;
    min-width: 1.5em;
  }

  /* Intensity states */
  .intensity-0 {
    color: #9ca3af;
  }
  :global(.dark) .intensity-0 {
    color: #6b7280;
  }

  .intensity-1 {
    color: #fca5a5;
  }

  .intensity-2 {
    color: #ef4444;
    filter: drop-shadow(0 0 4px rgb(239 68 68 / 0.5));
  }

  .intensity-3 {
    color: #dc2626;
    filter: drop-shadow(0 0 8px rgb(239 68 68 / 0.7));
  }

  .intensity-max {
    color: #ef4444;
    animation: persistent-glow 2s ease-in-out infinite;
  }

  @keyframes persistent-glow {
    0%,
    100% {
      filter: drop-shadow(0 0 6px rgb(239 68 68 / 0.5));
    }
    50% {
      filter: drop-shadow(0 0 12px rgb(239 68 68 / 0.8));
    }
  }

  /* Click animations */
  .anim-gentle-pulse {
    animation: gentle-pulse 300ms ease-out;
  }
  @keyframes gentle-pulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }

  .anim-medium-pulse {
    animation: medium-pulse 300ms ease-out;
  }
  @keyframes medium-pulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.3);
    }
    100% {
      transform: scale(1);
    }
  }

  .anim-strong-pulse {
    animation: strong-pulse 400ms ease-out;
  }
  @keyframes strong-pulse {
    0% {
      transform: scale(1) rotate(0deg);
    }
    30% {
      transform: scale(1.4) rotate(5deg);
    }
    60% {
      transform: scale(0.9) rotate(-5deg);
    }
    100% {
      transform: scale(1) rotate(0deg);
    }
  }

  .anim-burst {
    animation: burst 500ms ease-out;
  }
  @keyframes burst {
    0% {
      transform: scale(1);
    }
    40% {
      transform: scale(1.6);
    }
    100% {
      transform: scale(1);
    }
  }

  .anim-shake {
    animation: shake 300ms ease-out;
  }
  @keyframes shake {
    0% {
      transform: translateX(0);
    }
    25% {
      transform: translateX(-3px);
    }
    75% {
      transform: translateX(3px);
    }
    100% {
      transform: translateX(0);
    }
  }
</style>

<script>
  const MAX_LIKES = 10;

  function getStorage() {
    try {
      const key = '__storage_test__';
      localStorage.setItem(key, '1');
      localStorage.removeItem(key);
      return localStorage;
    } catch {
      return null;
    }
  }

  const storage = getStorage();
  const memoryStore: Record<string, number> = {};

  function getUserLikes(slug: string): number {
    if (storage) {
      return parseInt(storage.getItem(`likes:${slug}`) || '0', 10);
    }
    return memoryStore[slug] || 0;
  }

  function setUserLikes(slug: string, count: number) {
    if (storage) {
      storage.setItem(`likes:${slug}`, String(count));
    } else {
      memoryStore[slug] = count;
    }
  }

  function getIntensityClass(userLikes: number): string {
    if (userLikes >= MAX_LIKES) return 'intensity-max';
    if (userLikes >= 7) return 'intensity-3';
    if (userLikes >= 4) return 'intensity-2';
    if (userLikes >= 1) return 'intensity-1';
    return 'intensity-0';
  }

  function getClickAnimClass(userLikes: number): string | null {
    if (userLikes > MAX_LIKES) return 'anim-shake';
    if (userLikes === MAX_LIKES) return 'anim-burst';
    if (userLikes >= 7) return 'anim-strong-pulse';
    if (userLikes >= 4) return 'anim-medium-pulse';
    if (userLikes >= 1) return 'anim-gentle-pulse';
    return null;
  }

  const intensityClasses = ['intensity-0', 'intensity-1', 'intensity-2', 'intensity-3', 'intensity-max'];

  function setIntensity(heart: Element, userLikes: number) {
    heart.classList.remove(...intensityClasses);
    heart.classList.add(getIntensityClass(userLikes));
  }

  const buttons = document.querySelectorAll<HTMLButtonElement>('[data-like-button]');

  buttons.forEach((button) => {
    const slug = button.dataset.slug!;
    const heart = button.querySelector('.like-heart')!;
    const countEl = button.parentElement!.querySelector<HTMLSpanElement>('[data-like-count]')!;

    let userLikes = getUserLikes(slug);

    setIntensity(heart, userLikes);

    if (userLikes > 0) {
      countEl.textContent = String(userLikes);
    }

    fetch(`/.netlify/functions/get-likes?slug=${encodeURIComponent(slug)}`)
      .then((res) => {
        if (!res.ok) throw new Error('Failed to fetch');
        return res.json();
      })
      .then((data: { likes: number }) => {
        const serverCount = data.likes || 0;
        countEl.textContent = String(serverCount + getUserLikes(slug));
      })
      .catch(() => {
        if (userLikes === 0) {
          countEl.textContent = '\u2014';
        }
      });

    button.addEventListener('click', async () => {
      userLikes = getUserLikes(slug);

      if (userLikes >= MAX_LIKES) {
        const animClass = 'anim-shake';
        button.classList.remove(animClass);
        void button.offsetWidth;
        button.classList.add(animClass);
        button.addEventListener('animationend', () => button.classList.remove(animClass), { once: true });
        return;
      }

      const newUserLikes = userLikes + 1;
      const currentDisplay = parseInt(countEl.textContent || '0', 10);
      const newDisplay = isNaN(currentDisplay) ? newUserLikes : currentDisplay + 1;

      countEl.textContent = String(newDisplay);
      setUserLikes(slug, newUserLikes);
      setIntensity(heart, newUserLikes);

      const animClass = getClickAnimClass(newUserLikes);
      if (animClass) {
        button.classList.add(animClass);
        button.addEventListener('animationend', () => button.classList.remove(animClass), { once: true });
      }

      button.disabled = true;

      try {
        const res = await fetch('/.netlify/functions/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug }),
        });
        if (!res.ok) throw new Error('POST failed');
      } catch {
        const rolledBack = newDisplay - 1;
        countEl.textContent = rolledBack > 0 ? String(rolledBack) : '\u2014';
        setUserLikes(slug, userLikes);
        setIntensity(heart, userLikes);
      } finally {
        button.disabled = false;
      }
    });
  });
</script>
