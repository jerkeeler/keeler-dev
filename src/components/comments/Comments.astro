---
export interface Props {
  issueNumber: number;
}
const { issueNumber } = Astro.props;
---

<section class="mt-8" id="comments-section" data-issue={issueNumber}>
  <h2 class="text-2xl font-bold mb-4 dark:text-white">Comments</h2>
  <div id="comments-loading">Loading comments...</div>
  <div id="comments-error" class="hidden text-red-600 dark:text-red-400"></div>
  <div id="comments-empty" class="hidden text-gray-500 dark:text-gray-400">No comments yet.</div>
  <div id="comments-list" class="space-y-4"></div>
</section>

<script>
  import DOMPurify from 'dompurify';

  function timeAgo(dateString: string): string {
    const now = new Date();
    const date = new Date(dateString);
    const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);

    const intervals: [number, string][] = [
      [31536000, 'year'],
      [2592000, 'month'],
      [86400, 'day'],
      [3600, 'hour'],
      [60, 'minute'],
    ];

    for (const [secondsInUnit, label] of intervals) {
      const count = Math.floor(seconds / secondsInUnit);
      if (count >= 1) {
        return `${count} ${label}${count !== 1 ? 's' : ''} ago`;
      }
    }

    return 'just now';
  }

  (async () => {
    const section = document.getElementById('comments-section');
    const loading = document.getElementById('comments-loading');
    const error = document.getElementById('comments-error');
    const empty = document.getElementById('comments-empty');
    const list = document.getElementById('comments-list');

    if (!section || !loading || !error || !empty || !list) return;

    const issueNumber = section.dataset.issue;
    if (!issueNumber) return;

    try {
      const response = await fetch(`/api/comments?issue=${issueNumber}`);
      if (!response.ok) throw new Error('Failed to fetch comments');

      const data = await response.json();
      const comments: Array<{
        id: number;
        author: { login: string; avatarUrl: string };
        bodyHtml: string;
        createdAt: string;
      }> = data.comments;

      if (!comments || comments.length === 0) {
        empty.classList.remove('hidden');
      } else {
        for (const comment of comments) {
          const container = document.createElement('div');
          container.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-white dark:bg-gray-800';

          const header = document.createElement('div');
          header.className = 'flex items-center gap-3 mb-3';

          const avatar = document.createElement('img');
          avatar.src = comment.author.avatarUrl;
          avatar.alt = `${comment.author.login}'s avatar`;
          avatar.width = 32;
          avatar.height = 32;
          avatar.loading = 'lazy';
          avatar.className = 'rounded-full';

          const username = document.createElement('a');
          username.href = `https://github.com/${comment.author.login}`;
          username.textContent = comment.author.login;
          username.className =
            'font-medium text-gray-900 dark:text-gray-100 hover:underline decoration-primary decoration-2';
          username.target = '_blank';
          username.rel = 'noopener noreferrer';

          const timestamp = document.createElement('span');
          timestamp.className = 'text-sm text-gray-500 dark:text-gray-400';
          timestamp.textContent = timeAgo(comment.createdAt);

          header.appendChild(avatar);
          header.appendChild(username);
          header.appendChild(timestamp);

          const body = document.createElement('div');
          body.className = 'prose dark:prose-invert prose-sm max-w-none';
          body.innerHTML = DOMPurify.sanitize(comment.bodyHtml);

          container.appendChild(header);
          container.appendChild(body);
          list.appendChild(container);
        }
      }
    } catch {
      error.textContent = 'Could not load comments';
      error.classList.remove('hidden');
    } finally {
      loading.classList.add('hidden');
    }
  })();
</script>
